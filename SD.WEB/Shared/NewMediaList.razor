@inherits ComponentCore<NewMediaList>

@inject ExternalIdApi ExternalIdApi
@inject TmdbCreditApi TmdbCreditApi
@using SD.Shared.Models.List.Tmdb
@using SD.WEB.Modules.Collections.Core
@using SD.WEB.Modules.Collections.Interface

@if (ContainsHeader)
{
    <NewPageSection Title="@Title" Icon="@Icon" Image="@Image">
        <BodyFragment>
            <MudTabs KeepPanelsAlive="true" MinimumTabWidth="100" ApplyEffectsToContainer="true" PanelClass="@Css.Build().Small("pt")"
                     ActivePanelIndex="@(TypeSelected == MediaType.movie ? 0 : 1)"
                     ActivePanelIndexChanged="@(async (int index) => { var type = index == 0 ? MediaType.movie : MediaType.tv; await TypeSelectedChangedHandle(type); })">
                <Header>
                    <MudTooltip Text="Expand">
                        <MudIconButton Icon="@IconsFA.Solid.Icon("expand").Font" OnClick="@(() => Navigation.NavigateTo(GetCustomExpandUrl()))" Disabled="@(List == null && CustomExpand.Empty())" />
                    </MudTooltip>
                </Header>
                <ChildContent>
                    <MudTabPanel Text="@MediaType.movie.GetName()">
                        <NewRenderControl Actions="Actions" Instance="Items" ExpressionEmpty="@((HashSet<MediaDetail> list) => list.Empty())">
                            <div id="@_swiperId" class="swiper">
                                <div class="swiper-wrapper">
                                    @foreach (var item in Items)
                                    {
                                        <div class="swiper-slide" style="height: auto !important;">
                                            <PosterComponent Poster="@item.poster_small" Title="@item.title" Clicked="@(() => OpenPopupMedia(item))" MediaType="@item.MediaType"
                                                             Date="@item.release_date" OnlyYear="OnlyYear" ForceTypoTitle="ForceTypoTitle"
                                                             Rating="@item.rating" WishList="Wish" WatchedList="Watched" TmdbId="@item.tmdb_id" Comments="@item.comments" CommentsIsImage="CommentsIsImage">
                                            </PosterComponent>
                                        </div>
                                    }
                                </div>
                                <div class="swiper-button-next"></div>
                                <div class="swiper-button-prev"></div>
                            </div>
                        </NewRenderControl>
                    </MudTabPanel>
                    <MudTabPanel Text="@MediaType.tv.GetName()">
                        <NewRenderControl Actions="Actions" Instance="Items" ExpressionEmpty="@((HashSet<MediaDetail> list) => list.Empty())">
                            <div id="@_swiperId2" class="swiper">
                                <div class="swiper-wrapper">
                                    @foreach (var item in Items)
                                    {
                                        <div class="swiper-slide" style="height: auto !important;">
                                            <PosterComponent Poster="@item.poster_small" Title="@item.title" Clicked="@(() => OpenPopupMedia(item))" MediaType="@item.MediaType"
                                                             Date="@item.release_date" OnlyYear="OnlyYear" ForceTypoTitle="ForceTypoTitle"
                                                             Rating="@item.rating" WishList="Wish" WatchedList="Watched" TmdbId="@item.tmdb_id" Comments="@item.comments" CommentsIsImage="CommentsIsImage">
                                            </PosterComponent>
                                        </div>
                                    }
                                </div>
                                <div class="swiper-button-next"></div>
                                <div class="swiper-button-prev"></div>
                            </div>
                        </NewRenderControl>
                    </MudTabPanel>
                </ChildContent>
            </MudTabs>
        </BodyFragment>
    </NewPageSection>
}
else
{
    <NewRenderControl Actions="Actions" Instance="Items" ExpressionEmpty="@((HashSet<MediaDetail> list) => list.Empty())">
        <div id="@_swiperId" class="swiper">
            <div class="swiper-wrapper">
                @foreach (var item in Items)
                {
                    <div class="swiper-slide" style="height: auto !important;">
                        <PosterComponent Poster="@item.poster_small" Title="@item.title" Clicked="@(() => OpenPopupMedia(item))" MediaType="@item.MediaType"
                                         Date="@item.release_date" OnlyYear="OnlyYear" ForceTypoTitle="ForceTypoTitle"
                                         Rating="@item.rating" WishList="Wish" WatchedList="Watched" TmdbId="@item.tmdb_id" Comments="@item.comments" CommentsIsImage="CommentsIsImage">
                        </PosterComponent>
                    </div>
                }
            </div>
            <div class="swiper-button-next"></div>
            <div class="swiper-button-prev"></div>
        </div>
    </NewRenderControl>
}

@code {
    [Parameter][EditorRequired] public WatchedList? Watched { get; set; }
    [Parameter][EditorRequired] public WatchingList? Watching { get; set; }
    [Parameter][EditorRequired] public WishList? Wish { get; set; }

    [Parameter] public bool ContainsHeader { get; set; } = false;
    [Parameter] public string? TitleHead { get; set; }
    [Parameter] public string? Icon { get; set; }
    [Parameter] public string? Image { get; set; }
    [Parameter] public bool ShowFilter { get; set; }
    [Parameter] public bool OnlyYear { get; set; }
    [Parameter] public bool OrderByComments { get; set; }
    [Parameter] public bool CommentsIsImage { get; set; }
    [Parameter] public bool Popup { get; set; } = false;
    [Parameter] public string? CustomExpand { get; set; }
    [Parameter] public Typo? ForceTypoTitle { get; set; }

    [Parameter] public IMediaListApi? MediaListApi { get; set; }
    [Parameter] public EnumLists? List { get; set; }
    [Parameter] public Dictionary<string, string> StringParameters { get; set; } = new();
    [Parameter] public bool IsImdb { get; set; }

    [Parameter] public bool DetectRegions { get; set; }

    [Parameter] public MediaType TypeSelected { get; set; } = MediaType.movie;
    [Parameter] public EventCallback<MediaType> TypeSelectedChanged { get; set; }

    private string Title => TitleHead ?? List?.GetName() ?? "Title Error";

    public ComponentActions<HashSet<MediaDetail>> Actions { get; set; } = new();
    public HashSet<MediaDetail> Items { get; set; } = [];

    private readonly string _swiperId = $"swiper-{Guid.NewGuid()}";
    private readonly string _swiperId2 = $"swiper-{Guid.NewGuid()}";

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        try
        {
            if (MediaListApi == null) throw new ArgumentNullException(nameof(MediaListApi));
            // if (ShowHead && List == null && string.IsNullOrEmpty(TitleHead)) throw new ArgumentNullException(nameof(TitleHead));

            if (DetectRegions) AppStateStatic.RegionChanged += async region => await ProcessInitialData();
        }
        catch (Exception ex)
        {
            await ProcessException(ex);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        try
        {
            await base.OnAfterRenderAsync(firstRender);

            await JsRuntime.Swiper().InitLists(_swiperId);
            await JsRuntime.Swiper().InitLists(_swiperId2);
        }
        catch (Exception ex)
        {
            await ProcessException(ex);
        }
    }

    protected override async Task ProcessInitialData()
    {
        Actions?.StartLoading?.Invoke(null);
        await LoadItems();
        Actions?.FinishLoading?.Invoke(Items);
    }

    private async Task TypeSelectedChangedHandle(MediaType type)
    {
        Actions.StartLoading?.Invoke(null);
        TypeSelected = type;
        await TypeSelectedChanged.InvokeAsync(type);
        await LoadItems();
        Actions.FinishLoading?.Invoke(Items);
    }

    private async Task LoadItems()
    {
        try
        {
            if (MediaListApi != null)
            {
                var result = await MediaListApi.GetList([], TypeSelected, StringParameters, List);
                Items = result.list;

                if (Items.Count < 10) //force reload, if the filters bring few records
                {
                    var result2 = await MediaListApi.GetList(Items, TypeSelected, StringParameters, List, 2);
                    foreach (var item in result2.list)
                    {
                        Items.Add(item);
                    }
                }

                if (OrderByComments) Items = Items.OrderByDescending(o => int.Parse(o.comments?.Split(",").Last() ?? "0")).ToHashSet();
            }
        }
        catch (Exception ex)
        {
            Actions.ShowError?.Invoke(ex.Message);
        }
    }

    private string GetCustomExpandUrl()
    {
        if (List != null)
        {
            return $"/list/{(int)List}";
        }
        else if (!string.IsNullOrEmpty(CustomExpand))
        {
            return string.Format(CustomExpand, TypeSelected);
        }
        else
        {
            return string.Empty;
        }
    }

    private async Task OpenPopupMedia(MediaDetail? media)
    {
        try
        {
            string? tmdbId;

            if (IsImdb)
            {
                //for now, only tv series (imdb) need this kind of workaround (tmdb api only work with imdb id from movies - this info is not documented)
                tmdbId = await ExternalIdApi.GetTmdbId(media?.MediaType, media?.tmdb_id);
            }
            else
            {
                tmdbId = media?.tmdb_id;
            }

            if (tmdbId.Empty())
            {
                await ShowError("Unable to display this content. Please try again later.");
                return;
            }

            if (media?.MediaType == MediaType.person)
            {
                var result = await TmdbCreditApi.GetListByPerson(tmdbId);
                var items = new HashSet<MediaDetail>();

                foreach (var item in result?.crew ?? Enumerable.Empty<CrewByPerson>())
                {
                    var type = item.media_type == "tv" ? MediaType.tv : MediaType.movie;
                    items.Add(new MediaDetail
                    {
                        tmdb_id = item.id.ToString(),
                        title = type == MediaType.movie ? item.title : item.name,
                        plot = string.IsNullOrEmpty(item.overview) ? "No plot found" : item.overview,
                        release_date = type == MediaType.movie ? item.release_date?.GetDate() : item.first_air_date?.GetDate(),
                        poster_small = string.IsNullOrEmpty(item.poster_path) ? null : TmdbOptions.SmallPosterPath + item.poster_path,
                        poster_large = string.IsNullOrEmpty(item.poster_path) ? null : TmdbOptions.LargePosterPath + item.poster_path,
                        rating = item.vote_count > 10 ? item.vote_average ?? 0 : 0,
                        MediaType = type
                    });
                }

                foreach (var item in result?.cast ?? [])
                {
                    var type = item.media_type == "tv" ? MediaType.tv : MediaType.movie;

                    if (type == MediaType.movie && item.order > 24) continue;
                    if (type == MediaType.tv && item.episode_count < 3) continue;

                    items.Add(new MediaDetail
                    {
                        tmdb_id = item.id.ToString(),
                        title = type == MediaType.movie ? item.title : item.name,
                        plot = string.IsNullOrEmpty(item.overview) ? "No plot found" : item.overview,
                        release_date = type == MediaType.movie ? item.release_date?.GetDate() : item.first_air_date?.GetDate(),
                        poster_small = string.IsNullOrEmpty(item.poster_path) ? null : TmdbOptions.SmallPosterPath + item.poster_path,
                        poster_large = string.IsNullOrEmpty(item.poster_path) ? null : TmdbOptions.LargePosterPath + item.poster_path,
                        rating = item.vote_count > 10 ? item.vote_average ?? 0 : 0,
                        MediaType = type,
                        comments = type == MediaType.tv ? $"{item.episode_count} episodes" : ""
                    });
                }

                await DialogService.CompleteListPopup($"{media.title}", Watched, Watching, Wish, items.OrderByDescending(o => o.release_date).ToHashSet());
            }
            else
            {
                if (Popup)
                {
                    await DialogService.MediaPopup(Watched, Watching, Wish, media?.MediaType, tmdbId);
                }
                else
                {
                    Navigation.NavigateTo($"/media/{media?.MediaType.ToString().ToLower()}/{tmdbId}");
                }
            }
        }
        catch (Exception ex)
        {
            Actions.ShowError?.Invoke(ex.Message);
        }
    }

}