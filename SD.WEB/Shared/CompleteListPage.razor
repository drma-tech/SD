@page "/list/{id}"
@page "/collections/imdb/popular/{Type}"
@page "/collections/tmdb/popular/{Type}"
@page "/collections/tmdb/top/{Type}"
@page "/collections/tmdb/upcoming"
@page "/platforms/{id}/popular/{Type}"
@page "/platforms/{id}/new/{Type}"
@page "/platforms/{id}/top/{Type}"

@using SD.WEB.Modules.Collections.Core
@using SD.WEB.Modules.Collections.Interface
@using SD.WEB.Modules.Platform.Core
@using SD.WEB.Modules.Profile.Core
@using Button = SD.WEB.Resources.Button
@using SD.WEB.Modules.Subscription.Core
@inherits PageCore<CompleteListPage>

@inject WatchedListApi WatchedListApi
@inject WatchingListApi WatchingListApi
@inject WishListApi WishListApi
@inject AllProvidersApi AllProvidersApi
@inject IHttpClientFactory factory
@inject IpInfoApi IpInfoApi
@inject IpInfoServerApi IpInfoServerApi

<SeoHeader Title="@($"{Title}")" Description="@SeoTranslations.AppDescription" Keywords="@(new[] { Title })" Url="@($"/{Navigation.ToBaseRelativePath(Navigation.Uri)}")"></SeoHeader>

<GoogleAdSense Section="@GoogleAdSense.AdUnit.Platforms"></GoogleAdSense>

@if (MediaListApi != null)
{
    <MediaListFull Items="Items" ItemsChanged="@((HashSet<MediaDetail> list) => { Items = list; StateHasChanged(); })"
                   IsImdb="IsImdb" MediaListApi="MediaListApi" TypeSelected="TypeSelected" DetectRegions="DetectRegions"
                   StringParameters="StringParameters" List="List" TitleHead="@Title" ShowHead="false" FullPage="true"
                   Watched="Watched" Watching="Watching" Wish="Wish"
                   CommentsIsImage="CommentsIsImage" OrderByComments="OrderByComments" OnlyYear="OnlyYear">
    </MediaListFull>
}

@code {
    [Parameter] public string? id { get; set; }

    public HashSet<MediaDetail> Items { get; set; } = [];
    public WatchedList? Watched { get; set; }
    public WatchingList? Watching { get; set; }
    public WishList? Wish { get; set; }
    public bool OrderByComments { get; set; }

    public IMediaListApi? MediaListApi { get; set; }
    public bool IsImdb { get; set; } = false;
    public MediaType? TypeSelected { get; set; } = MediaType.movie;
    public Dictionary<string, string> StringParameters { get; set; } = new();
    public bool CommentsIsImage { get; set; } = false;
    [Parameter] public bool OnlyYear { get; set; }
    [Parameter] public string? Type { get; set; }
    public string? TitleHead { get; set; }
    public bool DetectRegions { get; set; }

    private EnumLists? List { get; set; }
    private string Title => TitleHead ?? $"{List?.GetCustomAttribute()?.Group} - {List?.GetName()}" ?? "Title Error";

    public Region Region { get; set; } = Region.US;

    protected override async Task OnInitializedAsync()
    {
        if (id.NotEmpty() && Navigation.Uri.Contains("list")) List = Enum.Parse<EnumLists>(id!);
        if (Type.NotEmpty()) TypeSelected = Enum.Parse<MediaType>(Type!, true);

        WatchedListApi.DataChanged += model => { Watched = model; StateHasChanged(); };
        WatchingListApi.DataChanged += model => { Watching = model; StateHasChanged(); };
        WishListApi.DataChanged += model => { Wish = model; StateHasChanged(); };

        Region = await AppStateStatic.GetRegion(IpInfoApi, IpInfoServerApi, JsRuntime);

        await ProcessNonList();

        MediaListApi ??= new TmdbListApi(factory);
    }

    protected override async Task LoadAuthDataAsync()
    {
        Watched = await WatchedListApi.Get(AppStateStatic.IsAuthenticated, null);
        Watching = await WatchingListApi.Get(AppStateStatic.IsAuthenticated, null);
        Wish = await WishListApi.Get(AppStateStatic.IsAuthenticated, null);
    }   

    private async Task ProcessNonList()
    {
        if (Navigation.Uri.Contains("imdb/popular"))
        {
            IsImdb = true;
            StringParameters = new() { { "mode", "full" } };
            OnlyYear = true;
            TitleHead = $"IMDB - {Modules.Platform.Resources.Translations.Popular} - {TypeSelected!.GetName()}";
            MediaListApi = new ImdbPopularApi(factory);
        }
        else if (Navigation.Uri.Contains("platforms"))
        {
            var providers = await AllProvidersApi.GetAll(null);
            var provider = providers?.Items.SingleOrDefault(s => s.id == id);

            if (Navigation.Uri.Contains("popular"))
            {
                TitleHead = $"{provider?.name} - {Modules.Platform.Resources.Translations.Popular} - {TypeSelected!.GetName()}";
                StringParameters = GetExtraParameters(id, "popularity.desc");
            }
            else if (Navigation.Uri.Contains("new"))
            {
                TitleHead = $"{provider?.name} - {Modules.Platform.Resources.Translations.Release} - {TypeSelected!.GetName()}";
                DetectRegions = true;
                StringParameters = GetExtraParameters(id, "primary_release_date.desc");
            }
            else if (Navigation.Uri.Contains("top"))
            {
                TitleHead = $"{provider?.name} - {Modules.Platform.Resources.Translations.TopRated} - {TypeSelected!.GetName()}";
                DetectRegions = true;
                StringParameters = GetExtraParameters(id, "vote_average.desc");
            }

            MediaListApi = new TmdbDiscoveryApi(factory);
        }
    }

    private static Dictionary<string, string> GetExtraParameters(string? providerId, string sortBy)
    {
        if (providerId == null) throw new ArgumentNullException(nameof(providerId));

        return new Dictionary<string, string> { { "with_watch_providers", providerId }, { "sort_by", sortBy } };
    }

}