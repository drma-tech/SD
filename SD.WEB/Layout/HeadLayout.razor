@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.JSInterop

@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject IJSRuntime JsRuntime

@inject EnergyApi EnergyApi
@inject EnergyAuthApi EnergyAuthApi

@if (_processing)
{
    <MudProgressLinear Color="Color.Secondary" Indeterminate="true" Style="position: fixed; z-index: 1400;" />
}
<MudAppBar Fixed="true" Elevation="1" Color="Color.Dark">
    @if (AppStateStatic.Breakpoint <= Breakpoint.Xs) //mobile view
    {
        <MudButton StartIcon="@IconsFA.Solid.Icon("house").Font" Color="@GetColor("/")" Href="/" Variant="@GetVariant("/")" Class="icon-text-button" Disabled="_blockedActions">
            @Menu.Home
        </MudButton>
        <MudButton StartIcon="@IconsFA.Solid.Icon("circle-user").Font" Color="@GetColor("/profile")" Href="/profile" Variant="@GetVariant("/profile")" Class="icon-text-button" Disabled="_blockedActions" Target="_self" Rel="noindex, nofollow">
            @Menu.Profile
        </MudButton>
        <MudButton StartIcon="@IconsFA.Solid.Icon("clapperboard").Font" Color="@GetColor("/platforms")" Href="/platforms" Variant="@GetVariant("/platforms")" Class="icon-text-button" Disabled="_blockedActions">
            @Menu.Platforms
        </MudButton>
        <MudSpacer />
        <MudTooltip Text="@GlobalTranslations.EnergyTooltip">
            <MudButton Color="Color.Primary" Variant="Variant.Filled" Class="me-2" Style="padding: 6px; min-width: auto;">
                <MudIcon Icon="@_energyIcon" Color="GetEnergyColor()"></MudIcon>
                <MudText>@(AppStateStatic.TotalEnergy - AppStateStatic.ConsumedEnergy)</MudText>
            </MudButton>
        </MudTooltip>
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@(() => { _open = true; })" />
    }
    else if (AppStateStatic.Breakpoint == Breakpoint.Sm) //tablet view
    {
        <MudButton StartIcon="@IconsFA.Solid.Icon("house").Font" Color="@GetColor("/")" Href="/" Variant="@GetVariant("/")" Class="icon-text-button" Disabled="_blockedActions">
            @Menu.Home
        </MudButton>
        <MudButton StartIcon="@IconsFA.Solid.Icon("circle-user").Font" Color="@GetColor("/profile")" Href="/profile" Variant="@GetVariant("/profile")" Class="icon-text-button" Disabled="_blockedActions" Target="_self" Rel="noindex, nofollow">
            @Menu.Profile
        </MudButton>
        <MudButton StartIcon="@IconsFA.Solid.Icon("clapperboard").Font" Color="@GetColor("/platforms")" Href="/platforms" Variant="@GetVariant("/platforms")" Class="icon-text-button" Disabled="_blockedActions">
            @Menu.Platforms
        </MudButton>
        <MudButton StartIcon="@IconsFA.Solid.Icon("headset").Font" Color="@GetColor("/support")" Href="/support" Variant="@GetVariant("/support")" Class="icon-text-button" Disabled="_blockedActions">
            @Menu.Support
        </MudButton>
        <MudSpacer />
        <MudTooltip Text="@GlobalTranslations.EnergyTooltip">
            <MudButton Color="Color.Primary" Variant="Variant.Filled" Class="me-2" Style="padding: 6px; min-width: auto;">
                <MudIcon Icon="@_energyIcon" Color="GetEnergyColor()"></MudIcon>
                <MudText>@(AppStateStatic.TotalEnergy - AppStateStatic.ConsumedEnergy)</MudText>
            </MudButton>
        </MudTooltip>
        @if (AppStateStatic.IsAuthenticated)
        {
            <MudIconButton Variant="Variant.Filled" Color="Color.Primary" Icon="@IconsFA.Solid.Icon("gem").Font" Class="me-2" OnClick="@OpenSubscription" />
        }
        else
        {
            <MudIconButton Variant="Variant.Filled" Color="Color.Warning" Icon="@IconsFA.Solid.Icon("gem").WithAnimation(IconAnimation.Fade).Font" Class="me-2" OnClick="@OpenSubscription" />
        }
        <AuthorizeView>
            <Authorized>
                <MudIconButton Variant="Variant.Filled" Color="Color.Primary" Icon="@IconsFA.Solid.Icon("circle-user").Font" Class="me-2" OnClick="@MyAccount" />
            </Authorized>
        </AuthorizeView>
        <MudIconButton Variant="Variant.Filled" Color="Color.Primary" Icon="@IconsFA.Solid.Icon("cog").Font" Class="me-2" OnClick="@OpenConfigurations" />
        <AuthorizeView>
            <Authorized>
                <MudButton Variant="Variant.Filled" Color="Color.Secondary" IconColor="Color.Error" OnClick="@Logout" Disabled="_blockedActions">
                    @Button.Logout
                </MudButton>
            </Authorized>
            <NotAuthorized>
                <MudButton Variant="Variant.Filled" Color="Color.Secondary" IconColor="Color.Secondary" OnClick="Login" Disabled="_blockedActions">
                    @Button.Login
                </MudButton>
            </NotAuthorized>
        </AuthorizeView>
    }
    else //desktop view
    {
        <MudButton StartIcon="@IconsFA.Solid.Icon("house").Font" Color="@GetColor("/")" Href="/" Variant="@GetVariant("/")" Class="px-3" Disabled="_blockedActions">
            @Menu.Home
        </MudButton>
        <MudButton StartIcon="@IconsFA.Solid.Icon("circle-user").Font" Color="@GetColor("/profile")" Href="/profile" Variant="@GetVariant("/profile")" Class="px-3" Disabled="_blockedActions" Target="_self" Rel="noindex, nofollow">
            @Menu.Profile
        </MudButton>
        <MudButton StartIcon="@IconsFA.Solid.Icon("clapperboard").Font" Color="@GetColor("/platforms")" Href="/platforms" Variant="@GetVariant("/platforms")" Class="px-3" Disabled="_blockedActions">
            @Menu.Platforms
        </MudButton>
        <MudSpacer />
        <MudTooltip Text="@GlobalTranslations.EnergyTooltip">
            <MudButton Color="Color.Primary" Variant="Variant.Filled" Class="me-2" Style="padding: 6px; min-width: auto;">
                <MudIcon Icon="@_energyIcon" Color="GetEnergyColor()"></MudIcon>
                <MudText>@(AppStateStatic.TotalEnergy - AppStateStatic.ConsumedEnergy)</MudText>
            </MudButton>
        </MudTooltip>
        @if (AppStateStatic.IsAuthenticated)
        {
            <MudIconButton Variant="Variant.Filled" Color="Color.Primary" Icon="@IconsFA.Solid.Icon("gem").Font" Class="me-2" OnClick="@OpenSubscription" />
        }
        else
        {
            <MudIconButton Variant="Variant.Filled" Color="Color.Warning" Icon="@IconsFA.Solid.Icon("gem").WithAnimation(IconAnimation.Fade).Font" Class="me-2" OnClick="@OpenSubscription" />
        }
        <AuthorizeView>
            <Authorized>
                <MudIconButton Variant="Variant.Filled" Color="Color.Primary" Icon="@IconsFA.Solid.Icon("circle-user").Font" Class="me-2" OnClick="@MyAccount" />
            </Authorized>
        </AuthorizeView>
        <MudIconButton Variant="Variant.Filled" Color="Color.Primary" Icon="@IconsFA.Solid.Icon("cog").Font" Class="me-2" OnClick="@OpenConfigurations" />
        <AuthorizeView>
            <Authorized>
                <MudButton Variant="Variant.Filled" Color="Color.Secondary" IconColor="Color.Error" OnClick="@Logout" Disabled="_blockedActions">
                    @Button.Logout
                </MudButton>
            </Authorized>
            <NotAuthorized>
                <MudButton Variant="Variant.Filled" Color="Color.Secondary" IconColor="Color.Secondary" OnClick="Login" Disabled="_blockedActions">
                    @Button.Login
                </MudButton>
            </NotAuthorized>
        </AuthorizeView>
    }
</MudAppBar>

@if (AppStateStatic.Breakpoint <= Breakpoint.Xs) //mobile menu
{
    <MudDrawer @bind-Open="@_open" Anchor="Anchor.Right" Elevation="1" OverlayAutoClose="true">
        <MudDrawerHeader>
            <MudText Typo="Typo.h6">@SeoTranslations.AppName</MudText>
        </MudDrawerHeader>
        <MudNavMenu>
            @if (AppStateStatic.IsAuthenticated)
            {
                <MudNavLink IconColor="Color.Primary" Icon="@IconsFA.Solid.Icon("gem").Font" OnClick="@OpenSubscription">
                    Subscription
                </MudNavLink>
            }
            else
            {
                <MudNavLink IconColor="Color.Warning" Icon="@IconsFA.Solid.Icon("gem").WithAnimation(IconAnimation.Fade).Font" OnClick="@OpenSubscription">
                    Subscription
                </MudNavLink>
            }
            <AuthorizeView>
                <Authorized>
                    <MudNavLink Icon="@IconsFA.Solid.Icon("circle-user").Font" OnClick="@MyAccount">
                        @Modules.Auth.Resources.Translations.MyAccount
                    </MudNavLink>
                </Authorized>
            </AuthorizeView>
            <MudNavLink Icon="@IconsFA.Solid.Icon("cog").Font" OnClick="@OpenConfigurations">
                Settings
            </MudNavLink>
            <MudNavLink Icon="@IconsFA.Solid.Icon("headset").Font" Href="/support">
                Support
            </MudNavLink>
            <MudDivider></MudDivider>
            <AuthorizeView>
                <Authorized>
                    <MudNavLink Icon="@IconsFA.Solid.Icon("right-from-bracket").Font" OnClick="@Logout" Disabled="_blockedActions" IconColor="Color.Secondary">
                        @Button.Logout
                    </MudNavLink>
                </Authorized>
                <NotAuthorized>
                    <MudNavLink Icon="@IconsFA.Solid.Icon("right-to-bracket").Font" OnClick="Login" Disabled="_blockedActions">
                        @Button.Login
                    </MudNavLink>
                </NotAuthorized>
            </AuthorizeView>
        </MudNavMenu>
    </MudDrawer>
}

@code {
    [Parameter]
    [SupplyParameterFromQuery(Name = "stripe_session_id")]
    public string? stripe_session_id { get; set; }

    private bool _open = false;

    private int _processingCount = 0;
    private bool _processing => _processingCount > 0;

    private string _energyIcon = IconsFA.Solid.Icon("bolt").Font;

    private bool _blockedActions => Navigation.Uri.Contains("register-user") || Navigation.Uri.Contains("ask-consent");

    protected override void OnInitialized()
    {
        Navigation.LocationChanged += delegate { StateHasChanged(); };
        AppStateStatic.BreakpointChanged += breakpoint => StateHasChanged();
        AppStateStatic.BrowserWindowSizeChanged += size => StateHasChanged();

        AppStateStatic.EnergyConsumed += () =>
        {
            AppStateStatic.ConsumedEnergy++;

            _energyIcon = IconsFA.Solid.Icon("bolt").WithAnimation(IconAnimation.Bounce).Font;

            Task.Delay(1000).ContinueWith(_ =>
            {
                _energyIcon = IconsFA.Solid.Icon("bolt").Font;
                InvokeAsync(StateHasChanged);
            });

            StateHasChanged();

            if (AppStateStatic.IsAuthenticated)
                InvokeAsync(EnergyAuthApi.AddEnergy);
            else
                InvokeAsync(EnergyApi.AddEnergy);
        };

        AppStateStatic.ProcessingStarted += () =>
        {
            Interlocked.Increment(ref _processingCount);
            InvokeAsync(StateHasChanged);
        };

        AppStateStatic.ProcessingFinished += async () =>
        {
            Interlocked.Decrement(ref _processingCount);

            await Task.Delay(200);

            if (_processingCount == 0)
            {
                await InvokeAsync(StateHasChanged);
            }
        };
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            if (stripe_session_id.NotEmpty())
            {
                await DialogService.SubscriptionPopup();
            }
        }

        await base.OnAfterRenderAsync(firstRender);
    }

    private async Task Login()
    {
        await PopupHelper.LoginPopup(DialogService);
    }

    private async Task Logout()
    {
        var auth = await JsRuntime.Utils().GetStorage<AuthProvider>("auth");

        if (auth == AuthProvider.Firebase)
            await JsRuntime.Firebase().SignOutAsync();
        else
            await JsRuntime.Supabase().SignOutAsync();
    }

    private async Task OpenConfigurations()
    {
        await DialogService.SettingsPopup();
    }

    private async Task MyAccount()
    {
        await DialogService.AccountPopup();
    }

    private Color GetColor(string endpoint)
    {
        return Focused(endpoint) ? Color.Primary : Color.Inherit;
    }

    private Variant GetVariant(string endpoint)
    {
        return Focused(endpoint) ? Variant.Filled : Variant.Text;
    }

    private bool Focused(string endpoint)
    {
        var uri = new Uri(Navigation.Uri);

        return string.Equals(uri.AbsolutePath, endpoint, StringComparison.OrdinalIgnoreCase);
    }

    private Color GetEnergyColor()
    {
        double ratio = (double)(AppStateStatic.TotalEnergy - AppStateStatic.ConsumedEnergy) / AppStateStatic.TotalEnergy;

        if (ratio <= 0.3)
            return Color.Error;
        else if (ratio <= 0.6)
            return Color.Warning;
        else
            return Color.Success;
    }

    private async Task OpenSubscription()
    {
        await DialogService.SubscriptionPopup();
    }

}
