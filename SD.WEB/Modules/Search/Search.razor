@page "/search"
@using SD.WEB.Modules.Collections.Core
@using SD.WEB.Modules.Profile.Core
@using SD.WEB.Shared.Core
@inherits PageCore<Search>

@inject TmdbSearchApi TmdbSearch
@inject WatchedListApi WatchedApi
@inject WatchingListApi WatchingApi
@inject WishListApi WishApi

<SeoHeader Title="Search" Description="@SeoTranslations.AppDescription" Url="/search" Index="false" Keywords="@([])"></SeoHeader>

<GoogleAdSense Section="@GoogleAdSense.AdUnit.Search"></GoogleAdSense>

<MudTextField T="string" Label="@GlobalTranslations.TypeSomething" @bind-Text="@AppStateStatic.Search" Immediate="true" OnKeyDown="@KeyPress"
              AdornmentIcon="@IconsFA.Solid.Icon("magnifying-glass").Font" Adornment="@(AppStateStatic.Search.NotEmpty() ? Adornment.End : Adornment.None)" AdornmentColor="Color.Primary"
              Variant="Variant.Outlined" OnAdornmentClick="@ProcessPageData" Class="@Css.Build().Large("mb")" Clearable="true"
              HelperText="Example: Superman, Dune, Dexter, Andor, Henry Cavill, Leonardo DiCaprio">
</MudTextField>

<RenderControl Actions="Actions">
    <MediaListFull MediaListApi="TmdbSearch" StringParameters="@StringParameters" Items="Items" ShowHead="false" FullPage="true"
                   Watched="Watched" Watching="Watching" Wish="Wish">
    </MediaListFull>
</RenderControl>

@code {
    public WatchedList? Watched { get; set; }
    public WatchingList? Watching { get; set; }
    public WishList? Wish { get; set; }

    private HashSet<MediaDetail> Items { get; set; } = [];
    private ComponentActions<HashSet<MediaDetail>> Actions { get; } = new(list => list == null || list.Empty());
    private Dictionary<string, string> StringParameters => new() { { "query", AppStateStatic.Search ?? "" } };

    protected override void OnInitialized()
    {
        Actions.CustomMessageWarning = GlobalTranslations.SearchReturnedNothing;

        WatchedApi.DataChanged += model => { Watched = model; StateHasChanged(); };
        WatchingApi.DataChanged += model => { Watching = model; StateHasChanged(); };
        WishApi.DataChanged += model => { Wish = model; StateHasChanged(); };
    }

    protected override async Task ProcessPageData()
    {
        await Actions.StartLoading.Invoke(null);
        Items.Clear();
        var result = await TmdbSearch.GetList(Items, null, StringParameters);
        Items = result.list;
        await Actions.FinishLoading.Invoke(Items);
    }

    protected override async Task LoadAuthDataAsync()
    {
        if (AppStateStatic.IsAuthenticated)
        {
            Watched ??= await WatchedApi.Get(true);
            Watching ??= await WatchingApi.Get(true);
            Wish ??= await WishApi.Get(true);
        }
        else
        {
            Watched = null;
            Watching = null;
            Wish = null;
        }
    }

    private async Task KeyPress(KeyboardEventArgs args)
    {
        if (AppStateStatic.Search.Empty()) return;

        if (args.Key == "Enter")
        {
            await ProcessPageData();
        }
    }

}