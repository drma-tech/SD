@page "/search"
@using SD.WEB.Modules.Collections.Core
@using SD.WEB.Modules.Profile.Core
@inherits PageCore<Search>

@inject TmdbSearchApi TmdbSearch
@inject WatchedListApi WatchedApi
@inject WatchingListApi WatchingApi
@inject WishListApi WishApi

<SeoHeader Title="Search" Description="@SeoTranslations.AppDescription" Url="/search" Index="false" Keywords="@([])"></SeoHeader>

<GoogleAdSense Section="@GoogleAdSense.AdUnit.Search" Format="horizontal"></GoogleAdSense>

<MudTextField T="string" Label="@GlobalTranslations.TypeSomething" @bind-Text="@AppStateStatic.Search" Immediate="true" OnKeyDown="@KeyPress"
              AdornmentIcon="@IconsFA.Solid.Icon("magnifying-glass").Font" Adornment="@(AppStateStatic.Search.NotEmpty() ? Adornment.End : Adornment.None)" AdornmentColor="Color.Primary"
              Variant="Variant.Outlined" OnAdornmentClick="@LoadNonEssentialDataAsync" Class="my-6" Clearable="true"
              HelperText="Example: Superman, Dune, Dexter, Andor, Henry Cavill, Leonardo DiCaprio">
</MudTextField>

<NewRenderControl Actions="Actions" Instance="Items" ExpressionEmpty="@((HashSet<MediaDetail> list) => list.Empty())" CustomMessageWarning="@GlobalTranslations.SearchReturnedNothing">
    <MediaListFull MediaListApi="TmdbSearch" StringParameters="@StringParameters" Items="Items" ShowHead="false" FullPage="true"
                   Watched="Watched" Watching="Watching" Wish="Wish">
    </MediaListFull>
</NewRenderControl>

@code {
    public WatchedList? Watched { get; set; }
    public WatchingList? Watching { get; set; }
    public WishList? Wish { get; set; }

    private HashSet<MediaDetail> Items { get; set; } = [];
    private ComponentActions<HashSet<MediaDetail>> Actions { get; } = new();
    private Dictionary<string, string> StringParameters => new() { { "query", AppStateStatic.Search ?? "" } };

    protected override void OnInitialized()
    {
        WatchedApi.DataChanged += model =>
        {
            Watched = model;
            StateHasChanged();
        };
        WatchingApi.DataChanged += model =>
        {
            Watching = model;
            StateHasChanged();
        };
        WishApi.DataChanged += model =>
        {
            Wish = model;
            StateHasChanged();
        };
    }

    protected override async Task LoadNonEssentialDataAsync()
    {
        Actions.StartLoading?.Invoke(null);
        Items.Clear();
        var result = await TmdbSearch.GetList(Items, null, StringParameters);
        Items = result.list;
        Actions.FinishLoading?.Invoke(Items);
    }

    protected override async Task LoadAuthDataAsync()
    {
        (Watched, Watching, Wish) = await (WatchedApi.Get(AppStateStatic.IsAuthenticated), WatchingApi.Get(AppStateStatic.IsAuthenticated), WishApi.Get(AppStateStatic.IsAuthenticated));
    }

    private async Task KeyPress(KeyboardEventArgs args)
    {
        if (AppStateStatic.Search.Empty()) return;

        if (args.Key == "Enter")
        {
            await LoadNonEssentialDataAsync();
        }
    }

}