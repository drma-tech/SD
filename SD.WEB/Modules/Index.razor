@page "/"
@page "/index"

@using SD.WEB.Modules.Collections.Core
@using SD.WEB.Modules.EditorsChoice.Components
@using SD.WEB.Modules.Profile.Core
@using SD.WEB.Modules.AwardsOfTheYear.Components
@using SD.WEB.Modules.Subscription.Core
@using SD.WEB.Modules.Trailers.Components
@using SD.WEB.Modules.News.Components
@inherits PageCore<Index>

@inject WatchedListApi WatchedApi
@inject WatchingListApi WatchingApi
@inject WishListApi WishApi
@inject PaymentConfigurationApi ConfigurationApi
@inject IpInfoApi IpInfoApi
@inject IpInfoServerApi IpInfoServerApi
@inject TmdbListApi TmdbListApi

<SeoHeader Title="@SeoTranslations.AppSubtitle" Description="@SeoTranslations.AppDescription" Url="/" Keywords="@(["streaming"])"></SeoHeader>
<NewPageSection IsPageHeader="true" Image="icon/icon-71.png" Title="@SeoTranslations.AppName" Subtitle="@SeoTranslations.AppSubtitle">
</NewPageSection>

<MudTextField T="string" Label="@GlobalTranslations.TypeSomething" @bind-Text="@AppStateStatic.Search" Immediate="true" OnKeyDown="@KeyPress" Class="@Css.Build().Large("mb")"
              AdornmentIcon="@IconsFA.Solid.Icon("magnifying-glass").Font" Adornment="@(AppStateStatic.Search.NotEmpty() ? Adornment.End : Adornment.None)" AdornmentColor="Color.Primary" Variant="Variant.Outlined"
              OnAdornmentClick="@(() =>{ if (AppStateStatic.Search.NotEmpty()) Navigation.NavigateTo($"/search"); })" Clearable="true"
              HelperText="Example: Superman, Dune, Dexter, Andor, Henry Cavill, Leonardo DiCaprio">
</MudTextField>

<GoogleAdSense Section="@GoogleAdSense.AdUnit.Index"></GoogleAdSense>

<PopularIndexComponent WatchedList="Watched" WatchingList="Watching" WishList="Wish"></PopularIndexComponent>

<EditorsChoiceComponent Watched="Watched" Watching="Watching" Wish="Wish"></EditorsChoiceComponent>

<AwardsOfTheYearComponent Watched="Watched" Watching="Watching" Wish="Wish"></AwardsOfTheYearComponent>

<GoogleAdSense Section="@GoogleAdSense.AdUnit.Index2"></GoogleAdSense>

<NewPageSection Title="@EnumLists.ExpectedMovieOf2026.GetName()">
    <BodyFragment>
        <MudTabs KeepPanelsAlive="true" MinimumTabWidth="100" ApplyEffectsToContainer="true" TabPanelsClass="@Css.Build().Small("pt")">
            <Header>
                <MudTooltip Text="Expand">
                    <MudIconButton Icon="@IconsFA.Solid.Icon("expand").Font" OnClick="@(() => Navigation.NavigateTo($"/list/{(int)EnumLists.ExpectedMovieOf2026}"))" />
                </MudTooltip>
            </Header>
            <ChildContent>
                <MudTabPanel Text="All">
                    <NewMediaList MediaListApi="TmdbListApi" List="@EnumLists.ExpectedMovieOf2026" Watched="Watched" Watching="Watching" Wish="Wish" />
                </MudTabPanel>
            </ChildContent>
        </MudTabs>
    </BodyFragment>
</NewPageSection>

<MudGrid Spacing="@Css.SpaceSmall">
    <MudItem xs="12" sm="6">
        <TrailersComponent></TrailersComponent>
    </MudItem>
    <MudItem xs="12" sm="6">
        <NewsComponent></NewsComponent>
    </MudItem>
</MudGrid>

@code {
    [Parameter][SupplyParameterFromQuery(Name = "language")] public string? Language { get; set; }

    private WatchedList? Watched { get; set; }
    private WatchingList? Watching { get; set; }
    private WishList? Wish { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        WatchedApi.DataChanged += model => { Watched = model; StateHasChanged(); };
        WatchingApi.DataChanged += model => { Watching = model; StateHasChanged(); };
        WishApi.DataChanged += model => { Wish = model; StateHasChanged(); };
    }

    protected override async Task LoadAuthDataAsync()
    {
        if (AppStateStatic.IsAuthenticated)
        {
            Watched ??= await WatchedApi.Get(true);
            Watching ??= await WatchingApi.Get(true);
            Wish ??= await WishApi.Get(true);
        }
        else
        {
            Watched = null;
            Watching = null;
            Wish = null;
        }
    }

    private void KeyPress(KeyboardEventArgs args)
    {
        if (AppStateStatic.Search.Empty()) return;

        if (args.Key == "Enter")
        {
            Navigation.NavigateTo("/search");
        }
    }

}