@page "/"
@page "/index"

@using SD.WEB.Modules.Collections.Core
@using SD.WEB.Modules.EditorsChoice.Components
@using SD.WEB.Modules.Profile.Core
@using SD.WEB.Modules.AwardsOfTheYear.Components
@using SD.WEB.Modules.Subscription.Core
@using SD.WEB.Modules.Trailers.Components
@using SD.WEB.Modules.News.Components
@inherits PageCore<Index>

@inject WatchedListApi WatchedApi
@inject WatchingListApi WatchingApi
@inject WishListApi WishApi
@inject PaymentConfigurationApi ConfigurationApi
@inject IpInfoApi IpInfoApi
@inject IpInfoServerApi IpInfoServerApi
@inject TmdbListApi TmdbListApi

<SeoHeader Title="@SeoTranslations.AppSubtitle" Description="@SeoTranslations.AppDescription" Url="/" Keywords="@(["streaming"])" anytinhg=""></SeoHeader>
<PageHeader Image="icon/icon-71.png" Title="@SeoTranslations.AppName" Subtitle="@SeoTranslations.AppSubtitle">
    <ActionFragment>
        <MudTooltip Text="@Modules.Profile.Resources.Translations.Subscription">
            <MudFab Color="Color.Primary" StartIcon="@IconsFA.Solid.Icon("gem").WithAnimation(IconAnimation.Fade).Font" IconColor="Color.Warning" Size="AppStateStatic.Size" OnClick="@OpenSubscription" />
        </MudTooltip>
    </ActionFragment>
</PageHeader>

<MudTextField T="string" Label="@GlobalTranslations.TypeSomething" @bind-Text="@AppStateStatic.Search" Immediate="true" OnKeyDown="@KeyPress" Class="mb-4"
              AdornmentIcon="@IconsFA.Solid.Icon("magnifying-glass").Font" Adornment="@(AppStateStatic.Search.NotEmpty() ? Adornment.End : Adornment.None)" AdornmentColor="Color.Primary" Variant="Variant.Outlined"
              OnAdornmentClick="@(() =>{ if (AppStateStatic.Search.NotEmpty()) Navigation.NavigateTo($"/search"); })" Clearable="true"
              HelperText="Example: Superman, Dune, Dexter, Andor, Henry Cavill, Leonardo DiCaprio">
</MudTextField>

<GoogleAdSense Section="@GoogleAdSense.AdUnit.Index"></GoogleAdSense>

<PopularIndexComponent WatchedList="Watched" WatchingList="Watching" WishList="Wish"></PopularIndexComponent>

<EditorsChoiceComponent Watched="Watched" Watching="Watching" Wish="Wish"></EditorsChoiceComponent>

<AwardsOfTheYearComponent Watched="Watched" Watching="Watching" Wish="Wish"></AwardsOfTheYearComponent>

<GoogleAdSense Section="@GoogleAdSense.AdUnit.Index2"></GoogleAdSense>

<MudGrid Spacing="3">
    <MudItem xs="12" sm="6">
        <MediaList MediaListApi="TmdbListApi" List="@EnumLists.ExpectedMovieOf2025" Watched="Watched" Watching="Watching" Wish="Wish">
        </MediaList>
    </MudItem>
    <MudItem xs="12" sm="6">
        <MediaList MediaListApi="TmdbListApi" List="@EnumLists.ExpectedMovieOf2026" Watched="Watched" Watching="Watching" Wish="Wish">
        </MediaList>
    </MudItem>
</MudGrid>

<MudGrid Spacing="3">
    <MudItem xs="12" sm="6">
        <TrailersComponent></TrailersComponent>
    </MudItem>
    <MudItem xs="12" sm="6">
        <NewsComponent></NewsComponent>
    </MudItem>
</MudGrid>

@code {

    [Parameter]
    [SupplyParameterFromQuery(Name = "language")]
    public string? Language { get; set; }

    public RenderControlCore<WatchedList?> CoreWatched { get; set; } = new();
    public RenderControlCore<WatchingList?> CoreWatching { get; set; } = new();
    public RenderControlCore<WishList?> CoreWish { get; set; } = new();

    public WatchedList? Watched { get; set; }
    public WatchingList? Watching { get; set; }
    public WishList? Wish { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        WatchedApi.DataChanged += model =>
        {
            Watched = model;
            CoreWatched.LoadingFinished?.Invoke(model);
            StateHasChanged();
        };
        WatchingApi.DataChanged += model =>
        {
            Watching = model;
            CoreWatching.LoadingFinished?.Invoke(model);
            StateHasChanged();
        };
        WishApi.DataChanged += model =>
        {
            Wish = model;
            CoreWish.LoadingFinished?.Invoke(model);
            StateHasChanged();
        };
    }

    protected override async Task LoadAuthDataAsync()
    {
        (Watched, Watching, Wish) = await (WatchedApi.Get(AppStateStatic.IsAuthenticated, CoreWatched), WatchingApi.Get(AppStateStatic.IsAuthenticated, CoreWatching), WishApi.Get(AppStateStatic.IsAuthenticated, CoreWish));
    }

    private void KeyPress(KeyboardEventArgs args)
    {
        if (AppStateStatic.Search.Empty()) return;

        if (args.Key == "Enter")
        {
            Navigation.NavigateTo("/search");
        }
    }

    private async Task OpenSubscription()
    {
        await DialogService.SubscriptionPopup();
    }

}