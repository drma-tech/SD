@inherits ComponentCore<SubscriptionPlans>

@using SD.Shared.Models.Subscription
@using SD.WEB.Modules.Subscription.Core
@using SD.WEB.Modules.Subscription.Resources

@inject PaymentConfigurationApi ConfigurationApi
@inject PaymentAuthApi PaymentAuthApi

<MudStack Row="true" Breakpoint="Breakpoint.Xs" Spacing="2">
    <MudCard Outlined="true" Elevation="4">
        <MudCardContent Class="pa-3">
            <MudText Typo="Typo.subtitle1" Align="Align.Center">@AccountProduct.Basic.GetName()</MudText>
            <MudText Typo="Typo.h6" Align="Align.Center">@Translations.Free</MudText>
            <MudGrid Spacing="1" Justify="Justify.SpaceBetween">
                <MudItem xs="9">
                    <MudText>@Translations.NoAds</MudText>
                </MudItem>
                <MudItem>
                    <MudChip T="string" Icon="@IconsFA.Solid.Icon("xmark").Font" Color="Color.Error" Size="Size.Small" Label="true" Class="chip-no-text" />
                </MudItem>
                <MudItem xs="9">
                    <MudText>Energy</MudText>
                </MudItem>
                <MudItem>
                    <MudChip T="string" Color="Color.Default" Size="Size.Small" Label="true">
                        <MudText>@AccountProduct.Basic.GetRestrictions().Energy.ToString()</MudText>
                    </MudChip>
                </MudItem>
                <MudItem xs="9">
                    <MudText>@Profile.Resources.Translations.MyPlatforms</MudText>
                </MudItem>
                <MudItem>
                    <MudChip T="string" Color="Color.Default" Size="Size.Small" Label="true">
                        <MudText>@AccountProduct.Basic.GetRestrictions().FavoriteProviders.ToString()</MudText>
                    </MudChip>
                </MudItem>
                <MudItem xs="9">
                    <MudText>@Profile.Resources.Translations.MySuggestions</MudText>
                </MudItem>
                <MudItem>
                    <MudChip T="string" Color="Color.Error" Size="Size.Small" Label="true">
                        <MudText>@AccountProduct.Basic.GetRestrictions().MySuggestions.ToString()</MudText>
                    </MudChip>
                </MudItem>
                <MudItem xs="9">
                    <MudText>@Profile.Resources.Translations.Watched</MudText>
                </MudItem>
                <MudItem>
                    <MudChip T="string" Color="Color.Default" Size="Size.Small" Label="true">
                        <MudText>@AccountProduct.Basic.GetRestrictions().Watched.ToString()</MudText>
                    </MudChip>
                </MudItem>
                <MudItem xs="9">
                    <MudText>@Profile.Resources.Translations.Watching</MudText>
                </MudItem>
                <MudItem>
                    <MudChip T="string" Color="Color.Default" Size="Size.Small" Label="true">
                        <MudText>@AccountProduct.Basic.GetRestrictions().Watching.ToString()</MudText>
                    </MudChip>
                </MudItem>
                <MudItem xs="9">
                    <MudText>@Profile.Resources.Translations.Wishlist</MudText>
                </MudItem>
                <MudItem>
                    <MudChip T="string" Color="Color.Default" Size="Size.Small" Label="true">
                        <MudText>@AccountProduct.Basic.GetRestrictions().Wishlist.ToString()</MudText>
                    </MudChip>
                </MudItem>
            </MudGrid>
        </MudCardContent>
        <MudCardActions>
            <MudButton Variant="Variant.Filled" Color="Color.Success" FullWidth="true" Disabled="true" Size="AppStateStatic.Size">
                @Modules.Subscription.Resources.Translations.YourCurrentPlan
            </MudButton>
        </MudCardActions>
    </MudCard>
    <MudCard Outlined="true" Elevation="4">
        <MudCardContent Class="pa-3">
            <MudText Typo="Typo.subtitle1" Align="Align.Center">@AccountProduct.Premium.GetName()</MudText>
            <MudText Typo="Typo.h6" Align="Align.Center">@GetPrice(AccountProduct.Premium, Cycle) / @Cycle.GetDescription()</MudText>
            <MudGrid Spacing="1" Justify="Justify.SpaceBetween">
                <MudItem xs="9">
                    <MudText>@Translations.NoAds</MudText>
                </MudItem>
                <MudItem>
                    <MudChip T="string" Icon="@IconsFA.Solid.Icon("check").Font" Color="Color.Success" Size="Size.Small" Label="true" Class="chip-no-text" />
                </MudItem>
                <MudItem xs="9">
                    <MudText>Energy</MudText>
                </MudItem>
                <MudItem>
                    <MudChip T="string" Color="Color.Default" Size="Size.Small" Label="true">
                        <MudText>@AccountProduct.Premium.GetRestrictions().Energy.ToString()</MudText>
                    </MudChip>
                </MudItem>
                <MudItem xs="9">
                    <MudText>@Profile.Resources.Translations.MyPlatforms</MudText>
                </MudItem>
                <MudItem>
                    <MudChip T="string" Color="Color.Default" Size="Size.Small" Label="true">
                        <MudText>@AccountProduct.Premium.GetRestrictions().FavoriteProviders.ToString()</MudText>
                    </MudChip>
                </MudItem>
                <MudItem xs="9">
                    <MudText>@Profile.Resources.Translations.MySuggestions</MudText>
                </MudItem>
                <MudItem>
                    <MudChip T="string" Color="Color.Default" Size="Size.Small" Label="true">
                        <MudText>@AccountProduct.Premium.GetRestrictions().MySuggestions.ToString()</MudText>
                    </MudChip>
                </MudItem>
                <MudItem xs="8">
                    <MudText>@Profile.Resources.Translations.Watched</MudText>
                </MudItem>
                <MudItem>
                    <MudChip T="string" Color="Color.Default" Size="Size.Small" Label="true">
                        <MudText>@AccountProduct.Premium.GetRestrictions().Watched.ToString()</MudText>
                    </MudChip>
                </MudItem>
                <MudItem xs="9">
                    <MudText>@Profile.Resources.Translations.Watching</MudText>
                </MudItem>
                <MudItem>
                    <MudChip T="string" Color="Color.Default" Size="Size.Small" Label="true">
                        <MudText>@AccountProduct.Premium.GetRestrictions().Watching.ToString()</MudText>
                    </MudChip>
                </MudItem>
                <MudItem xs="9">
                    <MudText>@Profile.Resources.Translations.Wishlist</MudText>
                </MudItem>
                <MudItem>
                    <MudChip T="string" Color="Color.Default" Size="Size.Small" Label="true">
                        <MudText>@AccountProduct.Premium.GetRestrictions().Wishlist.ToString()</MudText>
                    </MudChip>
                </MudItem>
            </MudGrid>
        </MudCardContent>
        <MudCardActions>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" Size="AppStateStatic.Size" OnClick="@(() => OpenCheckout(AccountProduct.Premium))"
                       Disabled="@(Provider == PaymentProvider.Stripe && Client != null && Client.StripeCustomerId.Empty())">
                @Translations.Select
            </MudButton>
        </MudCardActions>
    </MudCard>
</MudStack>
<MudText Typo="Typo.caption">
    * Prices are displayed in US dollars. Your payment provider may convert and/or adjust the amount based on your location and local taxes.
</MudText>

@code {
    [Parameter][EditorRequired] public PaymentProvider Provider { get; set; }
    [Parameter][EditorRequired] public AccountCycle Cycle { get; set; }
    [Parameter][EditorRequired] public AuthPrincipal? Client { get; set; }

    private PaymentConfigurations? Config { get; set; }

    protected override async Task LoadNonEssentialDataAsync()
    {
        Config = await ConfigurationApi.GetConfigurations(Provider);
    }

    public string? GetPrice(AccountProduct product, AccountCycle cycle)
    {
        return (product, cycle) switch
        {
            (AccountProduct.Premium, AccountCycle.Weekly) => "$0.99",
            (AccountProduct.Premium, AccountCycle.Monthly) => "$1.99",
            (AccountProduct.Premium, AccountCycle.Yearly) => "$19.99",
            _ => "$0.00",
        };
    }

    protected async Task OpenCheckout(AccountProduct product)
    {
        try
        {
            if (AppStateStatic.IsAuthenticated)
            {
                var priceId = Config?.GetPriceId(product, Cycle);

                if (Provider == PaymentProvider.Paddle)
                {
                    await ShowWarning($"Provider not available: {Provider.GetName()}");
                }
                else if (Provider == PaymentProvider.Apple)
                {
                    await JsRuntime.Payments().AppleOpenCheckout(priceId);
                }
                else if (Provider == PaymentProvider.Google)
                {
                    await JsRuntime.Payments().GoogleOpenCheckout(priceId, "type");
                }
                else if (Provider == PaymentProvider.Stripe)
                {
                    await JsRuntime.Payments().StripeOpenCheckout(priceId);
                }
                else
                {
                    await ShowWarning($"Provider not implemented: {Provider.GetName()}");
                }
            }
            else
            {
                await ShowWarning(GlobalTranslations.YouMustLoggedSubscribe);
            }
        }
        catch (Exception ex)
        {
            await ProcessException(ex);
        }
    }
}
